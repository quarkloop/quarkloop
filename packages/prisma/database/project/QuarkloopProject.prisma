generator client {
    provider        = "prisma-client-js"
    previewFeatures = ["multiSchema"]
}

datasource db {
    provider  = "postgresql"
    url       = env("PG_QUARKLOOP_PROJECT_URL") // uses connection pooling
    directUrl = env("PG_QUARKLOOP_PROJECT_URL_NON_POOLING") // used for migrations
    schemas   = ["project"]
}

model TableBranch {
    // id
    id        BigInt @id @default(autoincrement())
    projectId BigInt

    // branch
    name        String
    description String?
    default     Boolean @default(false)

    // history
    createdAt DateTime  @default(now())
    createdBy String
    updatedAt DateTime?
    updatedBy String?

    // relation
    mainTable TableMain[]
    documents TableDocument[]
    payments  TablePayment[]
    forms     TableForm[]

    @@unique([projectId, name])
    @@index([projectId])
    @@schema("project")
}

model TableSchema {
    // id
    id        BigInt @id @default(autoincrement())
    projectId BigInt

    // schema
    name        String
    description String?
    metadata    Json?
    data        Json

    // history
    createdAt DateTime  @default(now())
    createdBy String
    updatedAt DateTime?
    updatedBy String?

    // relation
    documents TableDocument[]
    payments  TablePayment[]
    forms     TableForm[]

    @@index([projectId])
    @@schema("project")
}

model TableMain {
    // id
    id        BigInt @id @default(autoincrement())
    projectId BigInt
    branchId  BigInt

    // main
    name        String
    description String?
    metadata    Json?
    data        Json

    // history
    createdAt DateTime  @default(now())
    createdBy String
    updatedAt DateTime?
    updatedBy String?

    // relation
    documents TableDocument[]
    payments  TablePayment[]
    forms     TableForm[]
    branch    TableBranch     @relation(fields: [branchId], references: [id])

    @@index([projectId, branchId])
    @@schema("project")
}

model TableDocument {
    // id
    id        BigInt @id @default(autoincrement())
    projectId BigInt
    branchId  BigInt
    mainId    BigInt
    schemaId  BigInt

    // document
    name        String
    description String?
    metadata    Json?
    data        Json

    // history
    createdAt DateTime  @default(now())
    createdBy String
    updatedAt DateTime?
    updatedBy String?

    // relation
    mainTable TableMain   @relation(fields: [mainId], references: [id])
    branch    TableBranch @relation(fields: [branchId], references: [id])
    schema    TableSchema @relation(fields: [schemaId], references: [id])

    @@index([projectId, branchId])
    @@index([projectId, branchId, mainId])
    @@schema("project")
}

model TablePayment {
    // id
    id        BigInt @id @default(autoincrement())
    projectId BigInt
    branchId  BigInt
    mainId    BigInt
    schemaId  BigInt

    // payment
    name        String
    description String?
    metadata    Json?
    data        Json

    // history
    createdAt DateTime  @default(now())
    createdBy String
    updatedAt DateTime?
    updatedBy String?

    // relation
    mainTable TableMain   @relation(fields: [mainId], references: [id])
    branch    TableBranch @relation(fields: [branchId], references: [id])
    schema    TableSchema @relation(fields: [schemaId], references: [id])

    @@index([projectId, branchId])
    @@index([projectId, branchId, mainId])
    @@schema("project")
}

model TableForm {
    // id
    id        BigInt @id @default(autoincrement())
    projectId BigInt
    branchId  BigInt
    mainId    BigInt
    schemaId  BigInt

    // form
    name        String
    description String?
    metadata    Json?
    data        Json

    // history
    createdAt DateTime  @default(now())
    createdBy String
    updatedAt DateTime?
    updatedBy String?

    // relation
    mainTable TableMain   @relation(fields: [mainId], references: [id])
    branch    TableBranch @relation(fields: [branchId], references: [id])
    schema    TableSchema @relation(fields: [schemaId], references: [id])

    @@index([projectId, branchId])
    @@index([projectId, branchId, mainId])
    @@schema("project")
}

model App {
    // id
    id        BigInt @id @default(autoincrement())
    projectId BigInt

    // app
    name        String
    description String?
    metadata    Json?
    data        Json

    // history
    createdAt DateTime  @default(now())
    createdBy String
    updatedAt DateTime?
    updatedBy String?

    @@schema("project")
}

model AppSubmission {
    // id
    id        BigInt @id @default(autoincrement())
    projectId BigInt

    // submission
    title    String
    status   Int       @default(1)
    labels   Json?
    dueDate  DateTime?
    metadata Json?
    data     Json

    // history
    createdAt DateTime  @default(now())
    createdBy String
    updatedAt DateTime?
    updatedBy String?

    // relation
    discussions AppDiscussion[]

    @@schema("project")
}

model AppDiscussion {
    // id
    id           BigInt @id @default(autoincrement())
    submissionId BigInt

    // discussion
    name        String
    description String?
    metadata    Json?
    data        Json

    // history
    createdAt DateTime  @default(now())
    createdBy String
    updatedAt DateTime?
    updatedBy String?

    // relation
    submission AppSubmission @relation(fields: [submissionId], references: [id])

    @@schema("project")
}
